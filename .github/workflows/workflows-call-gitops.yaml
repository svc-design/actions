name: Workflow Call Deploy App with Charts
on:
  workflow_call:
    inputs:
      helmfile:
        required: true
        type: string
    secrets:
      KUBE_CONFIG:
        required: true
      ARTIFACTORY_USER:
env:
  HELMFILE: ${{ inputs.helmfile }}
  KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

jobs:
  setup-argocd-crd:
    runs-on: self-hosted

    container:
      image: artifact.onwalk.net/public/base/alpine-chart-builder:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Set kube config
        run: |
          mkdir -p $HOME/.kube
          echo ${{ secrets.kube_config }} | base64 -d > $HOME/.kube/config

      - name: Set ArgoCD CRD
        run: |
          cat <<EOF > argocd-application.yaml
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: helmfile-application
            namespace: argocd
          spec:
            project: default
            source:
              repoURL: $git_repo
              path: $helmfile_name
              targetRevision: HEAD
              helm:
                releaseName: helmfile-application
            destination:
              server: https://kubernetes.default.svc
              namespace: default
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
          EOF
          # 应用 Argo CD Application 配置
          kubectl apply -f argocd-application.yaml
